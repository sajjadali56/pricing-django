<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload OS Data Files</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    {% load static %}
    <link rel="stylesheet" href="{% static 'os_page.css' %}">
    
</head>

<body>
    <!-- <div class="tab">
        <a href="{% url 'display_results' %}" class="display-results">PREMIUM RESULTS</a>
        <a href="{% url 'display_claims_results' %}" class="display-claims-results">CLAIMS RESULTS</a>
        <a href="{% url 'display_os_results' %}" class="display-os-results">OS RESULTS</a>
        <a href="{% url 'upload_and_display' %}" class="upload">UPLOAD PREMIUM FILES</a>
        <a href="{% url 'claims_file_upload' %}" class="claims-button">UPLOAD CLAIMS FILES</a>
        <a href="{% url 'os_file_upload' %}" class="claims-button">UPLOAD OS FILES</a>
        <a href="{% url 'upload_mapping' %}" class="upload_mapping">MAPPING SECTION</a>
        <a href="{% url 'mapping_upload' %}" class="mapping_upload">UPLOAD MAPPING</a>
        <a href="{% url 'Naming_Convention' %}" class="Naming_Convention">UAE NAMING</a>
        <a href="{% url 'display_os_results' %}" class="display-os-results">â†’</a>
    </div> -->
    {% include 'myapp/navbar2.html' %}
    
    <h1 class="pt-5 mt-5">Upload OS Data Files</h1>
    {% if message %}
        <p>{{ message }}</p>
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" action="{% url 'os_file_upload' %}" id="claimsForm">
        {% csrf_token %}
        {{ form.as_p }}
        {% if form.errors %}
            <div class="form-errors">
                Please correct the following errors: {{ form.errors }}
            </div>
        {% endif %}
        <button type="submit">Merge and Upload Files</button>

        {% if is_merged %}
        <br>
        <fieldset class="uploaded-files-info">
            <legend>Uploaded Files Information</legend>
            <p>Number of files merged: {{ file_details|length }}</p>
            <p>Total number of entries: {{ total_entries }}</p>
            <p>File names and entries:</p>
            <ul>
                {% for file in file_details %}
                <li>{{ file.name }} - {{ file.entries }} entries</li>
                {% endfor %}
            </ul>
        </fieldset>
        
        <fieldset>
            <legend>Is ClaimID available?</legend>
            <div class="radio-container">
                <label>
                    <input type="radio" name="claimId_available" value="yes" id="claimIdYes" onchange="toggleClaimIdFields(true)">
                    Yes
                </label>
                <label>
                    <input type="radio" name="claimId_available" value="no" id="claimIdNo" checked onchange="toggleClaimIdFields(false)">
                    No
                </label>
            </div>
        </fieldset>

        <br>
        <div id="conditionalFields" style="display: none;">
            <label>ClaimID:
                <select name="CLAIMID">
                    {% for column in columns %}
                        <option value="{{ column }}">{{ column }}</option>
                    {% endfor %}
                </select>
            </label>
            <br>
        </div>
    
        <p>UID SELECTION</p>
        <div class="radio-container">
            <label><input type="radio" name="selection" value="yes" onclick="toggleDisplay(true)"> Yes</label>
            <label><input type="radio" name="selection" value="no" onclick="toggleDisplay(false)"> No</label>
        </div>

        <div id="uidSection" style="display: none;">
            <p>UID:</p>
            <select name="UID">
                {% for column in columns %}
                    <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
            <br>
        </div>

        <div id="twoColumnsSection" style="display: none;">
            <p>SELECT COLUMNS FOR UID:</p>
            <input type="text" id="search_input_two_columns" list="unique_values_datalist_two_columns" placeholder="Search and select a value...">
            <datalist id="unique_values_datalist_two_columns"></datalist>
            <div id="selected_values_container_two_columns"></div>
            <div id="loading_two_columns" style="display: none;">Loading...</div>
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        </div>

        <br>
        LOSS DATE:
        <select name="LOSS_DATE">
            {% for column in columns %}
                <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
        </select>
        <br>
        CLAIM TYPE:
        <select name="CLAIM_TYPE">
            {% for column in columns %}
                <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
        </select>
        <br>
        OS AMOUNT 1:
        <select name="CLAIM_AMOUNT1">
            {% for column in columns %}
                <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
        </select>
        <br>
        OPERATOR:
        <select name="OPERATOR1">
            <option value="+">+</option>
            <option value="-">-</option>
        </select>
        <br>
        OS AMOUNT 2:
        <select name="CLAIM_AMOUNT2">
            {% for column in columns %}
                <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
        </select>
        <br>
        AsAtDate Is Available?
        <br>
        <div class="radio-container">
            <label><input type="radio" name="showSection" value="yes" onclick="toggleSectionDisplay()"> Yes</label>
            <label><input type="radio" name="showSection" value="no" onclick="toggleSectionDisplay()" checked> No</label>
        </div>
        
        <div id="toggleSection" style="display: none;">
            AsAtDate:
            <select name="AsAtDate" id="AsAtDateSelect">
                <option value="">Select a column</option>
                {% for column in columns %}
                    <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
            <input type="text" id="search_input" list="unique_values_datalist" name="selected_value" placeholder="Search and select a value...">
            <datalist id="unique_values_datalist"></datalist>
            <input type="hidden" name="selected_column" id="selected_column">
        </div>
        
        <label for="date_separator">Choose a date separator:</label>
        <select id="date_separator" name="date_separator" onchange="updateDateFormats();">
            <option value="-">Dash (-)</option>
            <option value="/">Slash (/)</option>
        </select>

        <label for="date_format">Choose a date format:</label>
        <select id="date_format" name="date_format"></select>
        <button type="submit" id="processDataButton" name="submit_type" value="process_data">Process Data</button>
        {% endif %}
    </form>

    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    {% if data_processed %}
        <p>Data has been processed successfully!</p>
        <a href="{% url 'download_processed_data' %}">Download Processed Data</a>
    {% endif %}

    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    
    <script>
        // Show loader on form submission
        document.getElementById('claimsForm').addEventListener('submit', function() {
            document.getElementById('loader').style.display = 'flex';
        });

        // Hide loader on page load
        window.addEventListener('load', function() {
            document.getElementById('loader').style.display = 'none';
        });

        function toggleClaimIdFields(isAvailable) {
            document.getElementById('conditionalFields').style.display = isAvailable ? 'block' : 'none';
        }
        
        function toggleSectionDisplay() {
            var showSection = document.querySelector('input[name="showSection"]:checked').value;
            var sectionToToggle = document.getElementById('toggleSection');
            sectionToToggle.style.display = showSection === 'yes' ? 'block' : 'none';
        }
        
        function toggleDisplay(isYesSelected) {
            document.getElementById('uidSection').style.display = isYesSelected ? 'block' : 'none';
            document.getElementById('twoColumnsSection').style.display = isYesSelected ? 'none' : 'block';
        }

        function fetchColumnData() {
            const loadingElement = document.getElementById('loading_two_columns');
            const dataList = document.getElementById('unique_values_datalist_two_columns');
            loadingElement.style.display = 'block';
            fetch(`/myapp/get_columns/`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    dataList.innerHTML = "";
                    data.columns.forEach(value => {
                        let option = document.createElement("option");
                        option.value = value;
                        dataList.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching column data:", error))
                .finally(() => loadingElement.style.display = 'none');
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            fetchColumnData();
            const searchInput = document.getElementById("search_input_two_columns");
            const dataList = document.getElementById("unique_values_datalist_two_columns");
            const selectedValuesContainer = document.getElementById("selected_values_container_two_columns");
        
            searchInput.addEventListener("input", function(event) {
                let inputValue = event.target.value.trim();
                let isOptionMatch = Array.from(dataList.options).some(option => option.value === inputValue);
                if (inputValue && isOptionMatch && !document.querySelector(`[data-value="${inputValue}"]`)) {
                    let div = document.createElement("div");
                    div.setAttribute("class", "selected-value");
                    div.setAttribute("data-value", inputValue);
                    div.textContent = inputValue + " (Click to remove)";
                    div.addEventListener("click", function() {
                        this.remove();
                        updateSelectedValues();
                    });
                    selectedValuesContainer.appendChild(div);
                    updateSelectedValues();
                    searchInput.value = "";
                }
            });
        });
        
        function updateSelectedValues() {
            let selectedDivs = document.querySelectorAll("#selected_values_container_two_columns .selected-value");
            let selectedValues = Array.from(selectedDivs).map(div => div.getAttribute("data-value"));
            fetch(`/myapp/handle_selected_values/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector("[name=csrfmiddlewaretoken]").value
                },
                body: JSON.stringify({ 'selectedValues': selectedValues })
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener("DOMContentLoaded", function() {
            const asAtDateSelect = document.getElementById('AsAtDateSelect');
            asAtDateSelect.addEventListener('change', function() {
                const selectedColumn = this.value;
                if (selectedColumn) {
                    fetch(`/myapp/get_unique_values/?column=${encodeURIComponent(selectedColumn)}`)
                        .then(response => response.json())
                        .then(data => {
                            const dataList = document.querySelector("#unique_values_datalist");
                            dataList.innerHTML = "";
                            data.unique_values.forEach(value => {
                                const option = document.createElement("option");
                                option.value = value;
                                dataList.appendChild(option);
                            });
                        })
                        .catch(error => console.error("Error fetching unique values:", error));
                } else {
                    document.querySelector("#unique_values_datalist").innerHTML = "";
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("search_input").addEventListener("change", function() {
                let selectedValue = this.value;
                if (!document.querySelector(`[data-value="${selectedValue}"]`)) {
                    let div = document.createElement("div");
                    div.setAttribute("data-value", selectedValue);
                    div.textContent = selectedValue + " (Click to remove)";
                    div.onclick = function() {
                        this.remove();
                    };
                    document.getElementById("selected_values_container").appendChild(div);
                }
                this.value = "";
            });
        });

        document.getElementById('claimIdYes').addEventListener('change', function() {
            document.getElementById('conditionalFields').style.display = 'block';
        });

        document.getElementById('claimIdNo').addEventListener('change', function() {
            document.getElementById('conditionalFields').style.display = 'none';
        });

        document.getElementById('processDataButton').addEventListener('click', function(event) {
            event.preventDefault();
            var form = document.getElementById('claimsForm');
            form.action = "{% url 'process_os_data' %}";
            form.submit();
        });

        function updateDateFormats() {
            var separator = document.getElementById('date_separator').value;
            var dateFormatSelect = document.getElementById('date_format');
            dateFormatSelect.innerHTML = '';
            var formats = [
                'dd' + separator + 'mm' + separator + 'yy',
                'mm' + separator + 'dd' + separator + 'yy',
                'dd' + separator + 'mm' + separator + 'yyyy',
                'mm' + separator + 'dd' + separator + 'yyyy',
                'yy' + separator + 'mm' + separator + 'dd',
                'yyyy' + separator + 'mm' + separator + 'dd'
            ];
            formats.forEach(function(format) {
                var option = document.createElement('option');
                option.value = format;
                option.text = format.toUpperCase();
                dateFormatSelect.appendChild(option);
            });
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            updateDateFormats();
            document.getElementById('date_separator').addEventListener('change', updateDateFormats);
        });
    </script>
</body>
</html>